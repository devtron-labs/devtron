apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-migrate-devtron
spec:
  ttlSecondsAfterFinished: 1000
  template:
    spec:
      containers:
      - name: postgresql-migrate-devtron
        image: quay.io/devtron/migrator:cb494756-390-10883
        env:
        - name: GIT_BRANCH
          value: main
        - name: SCRIPT_LOCATION
          value: scripts/sql/
        - name: GIT_REPO_URL
          value: https://github.com/devtron-labs/devtron.git
        - name: DB_TYPE
          value: postgres
        - name: DB_USER_NAME
          value: postgres
        - name: DB_HOST
          value: postgresql-postgresql.devtroncd
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: orchestrator                      
        - name: MIGRATE_TO_VERSION
          value: "0"
        - name: GIT_HASH
          value: 299b90b9322f40d84ebac23a9b43d0bbe23c56ca
        envFrom:
          - secretRef:
              name: postgresql-migrator
        resources:
          requests:
            memory: "250Mi"
            cpu: "100m"
          limits:
            memory: "250Mi"
            cpu: "100m"
      restartPolicy: OnFailure
  backoffLimit: 20
  activeDeadlineSeconds: 1500
---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-migrate-casbin
spec:
  template:
    spec:
      serviceAccountName: devtron
      containers:
      - name: devtron-rollout
        image: quay.io/bitnami/kubectl:latest
        command: ['sh', '-c', 'kubectl rollout restart deployment/devtron -n devtroncd']
        resources:
          requests:
            memory: "50Mi"
            cpu: "25m"
          limits:
            memory: "50Mi"
            cpu: "25m"
      initContainers:
      - name: postgresql-migrate-casbin
        image: quay.io/devtron/migrator:cb494756-390-10883
        env:
        - name: SCRIPT_LOCATION
          value: scripts/casbin/
        - name: GIT_REPO_URL
          value: https://github.com/devtron-labs/devtron.git
        - name: DB_TYPE
          value: postgres
        - name: DB_USER_NAME
          value: postgres
        - name: DB_HOST
          value: postgresql-postgresql.devtroncd
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: casbin
        - name: MIGRATE_TO_VERSION
          value: "0"
        - name: GIT_HASH
          value: 299b90b9322f40d84ebac23a9b43d0bbe23c56ca
        - name: GIT_BRANCH
          value: main
        envFrom:
          - secretRef:
              name: postgresql-migrator
        resources:
          requests:
            memory: "250Mi"
            cpu: "100m"
          limits:
            memory: "250Mi"
            cpu: "100m"
      restartPolicy: OnFailure
  backoffLimit: 20
  activeDeadlineSeconds: 1500