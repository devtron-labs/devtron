openapi: 3.0.3
info:
  version: 1.0.0
  title: Application Type Change API
paths:
  /orchestrator/app/cd-pipeline/patch/deployment:
    post:
      description: Bulk change deployment app type of all cd pipelines in an environment
      requestBody:
        description: A JSON object containing environment id and desired deployment app type
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeploymentAppTypeChangeRequest'
      responses:
        '200':
          description: successfully returns an object with info on pipelines successfully changed deployment types and pipelines failed to change deployment app type with error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
        '401':
          description: unauthorized user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Bad Request. Validation error/wrong request body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

# components mentioned below
components:
  schemas:
    DeploymentAppTypeChangeRequest:
      type: object
      required:
        - envId
        - desiredDeploymentType
      properties:
        envId:
          type: integer
          description: Environment id
        desiredDeploymentType:
          type: string
          description: Desired deployment type. For eg argo_cd / helm
          enum: [argo_cd, helm]
        excludeApps:
          type: array
          items:
            type: integer
          description: List of app ids to be excluded
        includeApps:
          type: array
          items:
            type: integer
          description: List of app ids to be included (deployment will be changed only for these apps)
        autoTriggerDeployment:
          type: boolean
          description: Whether to automatically trigger deployment after type change
        userId:
          type: integer
          format: int32
          description: User ID who initiated the change
    DeploymentChangeStatus:
      type: object
      properties:
        pipelineId:
          type: integer
          description: CD pipeline id
        installedAppId:
          type: integer
          description: Installed app id (for chart store apps)
        appId:
          type: integer
          description: App id
        appName:
          type: string
          description: App name
        envId:
          type: integer
          description: Environment id
        envName:
          type: string
          description: Environment name
        error:
          type: string
          description: Error message if failed to change deployment app type
        status:
          type: string
          description: Status of deployment change
          enum: [Success, Failed, INITIATED, NOT_YET_DELETED, permission denied]
    DeploymentAppTypeChangeResponse:
      type: object
      properties:
        envId:
          type: integer
          description: Environment id
        desiredDeploymentType:
          type: string
          description: Desired deployment type
          enum: [argo_cd, helm]
        successfulPipelines:
          type: array
          description: Pipelines which were successfully changed
          items:
            $ref: '#/components/schemas/DeploymentChangeStatus'
        failedPipelines:
          type: array
          description: Pipelines which failed to change deployment app type
          items:
            $ref: '#/components/schemas/DeploymentChangeStatus'
        triggeredPipelines:
          type: array
          description: Pipelines for which deployment was triggered
          items:
            type: object
            properties:
              ciArtifactId:
                type: integer
                description: CI artifact id
              pipelineId:
                type: integer
                description: Pipeline id
    OkResponse:
      type: object
      required:
        - code
        - status
        - result
      properties:
        code:
          type: integer
          format: int32
          description: HTTP status code
        status:
          type: string
          description: Status message
        result:
          $ref: '#/components/schemas/DeploymentAppTypeChangeResponse'
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          example: E100
        message:
          type: string
          description: Error message
          example: User is not authenticated
        internalMessage:
          type: string
          description: Internal error message for debugging
        userMessage:
          type: string
          description: User-friendly error message
  
