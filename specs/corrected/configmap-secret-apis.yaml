openapi: "3.0.3"
info:
  title: Devtron ConfigMap and Secret Management API
  description: |
    API specifications for ConfigMap and Secret management in Devtron orchestrator.
    These specifications match the actual backend implementation exactly.
  version: "1.0.0"
  contact:
    name: Devtron Support
    email: support@devtron.ai
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: /orchestrator
    description: Devtron Orchestrator API Server

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

  schemas:
    ApiResponse:
      type: object
      properties:
        code:
          type: integer
          description: HTTP status code
        status:
          type: string
          description: Response status
        result:
          type: object
          description: Response data

    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
          description: Error code
        status:
          type: string
          description: Error status
        errors:
          type: array
          items:
            type: string
          description: List of error messages

    ConfigDataRequest:
      type: object
      description: Request structure for ConfigMap/Secret operations
      required:
        - appId
        - configData
      properties:
        id:
          type: integer
          description: ID of the ConfigMap/Secret (0 for new)
          example: 0
        appId:
          type: integer
          description: Application ID
          example: 123
        environmentId:
          type: integer
          description: Environment ID (for environment-specific configs)
          example: 456
        configData:
          type: array
          description: Array of ConfigData objects
          items:
            $ref: '#/components/schemas/ConfigData'
        isDeletable:
          type: boolean
          description: Whether the config is deletable
          default: true

    ConfigData:
      type: object
      description: Individual ConfigMap or Secret data
      required:
        - name
        - type
      properties:
        name:
          type: string
          description: Name of the ConfigMap/Secret
          example: "global-configmap"
        type:
          type: string
          description: Type of configuration
          enum: ["CONFIGMAP", "SECRET"]
          example: "CONFIGMAP"
        external:
          type: boolean
          description: Whether this is an external ConfigMap/Secret
          default: false
        mountPath:
          type: string
          description: Path where the ConfigMap/Secret should be mounted
          example: "/etc/config"
        data:
          type: object
          description: Configuration data as key-value pairs
          additionalProperties:
            type: string
          example:
            key1: "value1"
            key2: "value2"
        global:
          type: boolean
          description: Whether this is a global configuration
          default: true
        subPath:
          type: boolean
          description: Whether to use subPath mounting
          default: false
        filePermission:
          type: string
          description: File permission for mounted files
          example: "0644"

    ConfigsList:
      type: object
      properties:
        maps:
          type: array
          items:
            $ref: '#/components/schemas/ConfigData'

tags:
  - name: Global ConfigMaps
    description: Global ConfigMap management operations
  - name: Global Secrets
    description: Global Secret management operations
  - name: Environment ConfigMaps
    description: Environment-specific ConfigMap operations
  - name: Environment Secrets
    description: Environment-specific Secret operations

paths:
  /config/global/cm:
    post:
      tags:
        - Global ConfigMaps
      summary: Create or update global ConfigMap
      description: |
        Creates a new global ConfigMap or updates an existing one.
        This endpoint handles both create and update operations based on the ID field.
      operationId: CMGlobalAddUpdate
      requestBody:
        description: ConfigMap configuration request
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigDataRequest'
            example:
              id: 0
              appId: 123
              configData:
                - name: "global-configmap"
                  type: "CONFIGMAP"
                  external: false
                  mountPath: "/etc/config"
                  data:
                    key1: "value1"
                    key2: "value2"
                  global: true
                  subPath: false
                  filePermission: "0644"
              isDeletable: true
      responses:
        '200':
          description: ConfigMap created/updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /config/global/cs:
    post:
      tags:
        - Global Secrets
      summary: Create or update global Secret
      description: |
        Creates a new global Secret or updates an existing one.
        This endpoint handles both create and update operations based on the ID field.
      operationId: CSGlobalAddUpdate
      requestBody:
        description: Secret configuration request
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigDataRequest'
            example:
              id: 0
              appId: 123
              configData:
                - name: "global-secret"
                  type: "SECRET"
                  external: false
                  mountPath: "/etc/secrets"
                  data:
                    username: "admin"
                    password: "s3cr3t"
                  global: true
                  subPath: false
                  filePermission: "0600"
              isDeletable: true
      responses:
        '200':
          description: Secret created/updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /config/global/cm/{appId}:
    get:
      tags:
        - Global ConfigMaps
      summary: Get global ConfigMaps for application
      description: Retrieves all global ConfigMaps for the specified application
      operationId: CMGlobalFetch
      parameters:
        - name: appId
          in: path
          description: Application ID
          required: true
          schema:
            type: integer
          example: 123
      responses:
        '200':
          description: Global ConfigMaps retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      result:
                        $ref: '#/components/schemas/ConfigsList'
        '400':
          description: Invalid application ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Application not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
