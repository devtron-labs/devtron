openapi: 3.0.3
info:
  version: 1.0.0
  title: Devtron Orchestrator Deployment Template & Configuration API
  description: |
    API specifications for Devtron orchestrator deployment template creation and 
    environment/deployment configuration management endpoints.
  termsOfService: https://devtron.ai/terms/
  contact:
    name: Devtron Support
    email: support@devtron.ai
    url: https://devtron.ai/support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: /orchestrator
    description: Devtron Orchestrator API Server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

  schemas:
    ApiResponse:
      type: object
      properties:
        code:
          type: integer
          description: HTTP status code
        status:
          type: string
          description: Status message
        result:
          type: object
          description: Response result data

    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
          description: Error code
        status:
          type: string
          description: Error status
        errors:
          type: array
          items:
            type: string
          description: List of error messages

    DeploymentTemplate:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Template ID
        name:
          type: string
          description: Template name
        description:
          type: string
          description: Template description
        chartRefId:
          type: integer
          format: int64
          description: Chart reference ID
        version:
          type: string
          description: Template version
        isAppMetricsEnabled:
          type: boolean
          description: Whether application metrics are enabled
        defaultAppOverride:
          type: object
          description: Default application override values
        globalConfig:
          type: object
          description: Global configuration
        pipelineStrategy:
          type: object
          description: Pipeline strategy configuration
        createdOn:
          type: string
          format: date-time
          description: Template creation timestamp
        createdBy:
          type: integer
          description: ID of user who created the template

    CreateTemplateRequest:
      type: object
      required:
        - name
        - chartRefId
      properties:
        name:
          type: string
          description: Template name
          minLength: 1
          maxLength: 100
        description:
          type: string
          description: Template description
        chartRefId:
          type: integer
          format: int64
          description: Chart reference ID
        isAppMetricsEnabled:
          type: boolean
          description: Whether application metrics are enabled
          default: false
        defaultAppOverride:
          type: object
          description: Default application override values
        globalConfig:
          type: object
          description: Global configuration
        pipelineStrategy:
          type: object
          description: Pipeline strategy configuration

    EnvironmentConfig:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Environment configuration ID
        environmentId:
          type: integer
          format: int64
          description: Environment ID
        environmentName:
          type: string
          description: Environment name
        namespace:
          type: string
          description: Kubernetes namespace
        clusterId:
          type: integer
          format: int64
          description: Cluster ID
        clusterName:
          type: string
          description: Cluster name
        isProduction:
          type: boolean
          description: Whether this is a production environment
        environmentType:
          type: string
          enum: [PRODUCTION, NON_PRODUCTION]
          description: Environment type
        description:
          type: string
          description: Environment description
        active:
          type: boolean
          description: Whether the environment is active

    DeploymentConfig:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Deployment configuration ID
        appId:
          type: integer
          format: int64
          description: Application ID
        environmentId:
          type: integer
          format: int64
          description: Environment ID
        templateVersion:
          type: string
          description: Template version
        pipelineStrategy:
          type: object
          description: Pipeline strategy configuration
        configMapData:
          type: object
          description: ConfigMap data
        secretData:
          type: object
          description: Secret data
        envOverrideValues:
          type: object
          description: Environment override values
        mergedValues:
          type: object
          description: Merged configuration values
        status:
          type: string
          enum: [DRAFT, PUBLISHED]
          description: Configuration status
        createdOn:
          type: string
          format: date-time
          description: Configuration creation timestamp
        createdBy:
          type: integer
          description: ID of user who created the configuration

    UpdateDeploymentConfigRequest:
      type: object
      required:
        - appId
        - environmentId
      properties:
        appId:
          type: integer
          format: int64
          description: Application ID
        environmentId:
          type: integer
          format: int64
          description: Environment ID
        templateVersion:
          type: string
          description: Template version
        pipelineStrategy:
          type: object
          description: Pipeline strategy configuration
        configMapData:
          type: object
          description: ConfigMap data
        secretData:
          type: object
          description: Secret data
        envOverrideValues:
          type: object
          description: Environment override values

    TemplateValidationResponse:
      type: object
      properties:
        isValid:
          type: boolean
          description: Whether the template is valid
        errors:
          type: array
          items:
            type: string
          description: Validation error messages
        warnings:
          type: array
          items:
            type: string
          description: Validation warning messages
        chartInfo:
          type: object
          description: Chart information
          properties:
            name:
              type: string
              description: Chart name
            version:
              type: string
              description: Chart version
            description:
              type: string
              description: Chart description

tags:
  - name: Deployment Templates
    description: Operations for managing deployment templates
  - name: Environment Configuration
    description: Operations for managing environment configurations
  - name: Deployment Configuration
    description: Operations for managing deployment configurations

paths:
  /deployment/template/create:
    post:
      tags:
        - Deployment Templates
      summary: Create deployment template
      description: Creates a new deployment template from uploaded chart or configuration
      operationId: createDeploymentTemplate
      requestBody:
        description: Template creation request
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        '200':
          description: Template created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      result:
                        $ref: '#/components/schemas/DeploymentTemplate'
        '400':
          description: Invalid request format or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /deployment/template/validate:
    post:
      tags:
        - Deployment Templates
      summary: Validate deployment template
      description: Validates a deployment template file upload
      operationId: validateDeploymentTemplate
      requestBody:
        description: Template file for validation
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                BinaryFile:
                  type: string
                  format: binary
                  description: Zipped chart template file
      responses:
        '200':
          description: Template validation completed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      result:
                        $ref: '#/components/schemas/TemplateValidationResponse'
        '400':
          description: Invalid file format or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /config/environment:
    get:
      tags:
        - Environment Configuration
      summary: Get environment configuration
      description: Retrieves environment configuration details
      operationId: getEnvironmentConfiguration
      parameters:
        - name: environmentId
          in: query
          description: Environment ID to filter by
          required: false
          schema:
            type: integer
            format: int64
        - name: clusterId
          in: query
          description: Cluster ID to filter by
          required: false
          schema:
            type: integer
            format: int64
        - name: appId
          in: query
          description: Application ID to filter by
          required: false
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Environment configuration retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      result:
                        type: array
                        items:
                          $ref: '#/components/schemas/EnvironmentConfig'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /config/update:
    put:
      tags:
        - Deployment Configuration
      summary: Update deployment configuration
      description: Updates deployment configuration for an application in a specific environment
      operationId: updateDeploymentConfiguration
      requestBody:
        description: Deployment configuration update request
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDeploymentConfigRequest'
      responses:
        '200':
          description: Deployment configuration updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      result:
                        $ref: '#/components/schemas/DeploymentConfig'
        '400':
          description: Invalid request format or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Application or environment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []
