name: Centralized PR Validation

on:
  workflow_call:
    inputs:
      validate_sql:
        description: "Check SQL migrations"
        required: true
        type: boolean
    secrets:
      GH_TOKEN:
        required: true

jobs:
  pr-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up jq (for parsing JSON)
      run: sudo apt-get install -y jq

    - name: PR Validation Script
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
        PRNUM: ${{ github.event.pull_request.number }}
        TITLE: ${{ github.event.pull_request.title }}
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        BASE_REPO="${{ github.event.pull_request.base.repo.full_name }}"
        HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
        FORKED=false

        if [[ "$BASE_REPO" != "$HEAD_REPO" ]]; then
          FORKED=true
        fi

        # Skip validation for documentation or chore PRs
        if [[ "$TITLE" =~ ^(doc:|docs:|chore:|misc:|Release:|release:|Sync:|sync:) ]]; then
          echo "Skipping validation for docs/chore PR."
          gh pr edit "$PRNUM" --remove-label "PR:Issue-verification-failed" --add-label "PR:Ready-to-Review"
          exit 0
        fi

        # Define issue matching patterns
        PATTERNS=(
            "((Fixes|Resolves) #[0-9]+)"
            "((Fixes|Resolves) https://github.com/devtron-labs/(devtron|sprint-tasks|devops-sprint)/issues/[0-9]+)"
            "((Fixes|Resolves) devtron-labs/devtron#[0-9]+)"
            "((Fixes|Resolves) devtron-labs/sprint-tasks#[0-9]+)"
            "((Fixes|Resolves) devtron-labs/devops-sprint#[0-9]+)"
            "(Fixes|Resolves):?\\s+\\[#([0-9]+)\\]"
            "((Fixes|Resolves):? #devtron-labs/devops-sprint/issues/[0-9]+)"
            "((Fixes|Resolves):? #devtron-labs/sprint-tasks/issues/[0-9]+)"
        )

        # Function to extract issue number and repo from PR body
        extract_issue() {
          for pattern in "${PATTERNS[@]}"; do
            if [[ "$PR_BODY" =~ $pattern ]]; then
              issue_num="${BASH_REMATCH[0]}"
              issue_num=$(echo "$issue_num" | grep -oE '[0-9]+')
              repo=$(echo "$PR_BODY" | grep -oE "devtron-labs/[a-zA-Z0-9_-]+")
              echo "Found issue #$issue_num in repo: $repo"
              return 0
            fi
          done
          return 1
        }

        # Extract issue number and repo
        extract_issue || { 
          echo "No valid issue number found."
          gh pr edit "$PRNUM" --add-label "PR:Issue-verification-failed" --remove-label "PR:Ready-to-Review"
          exit 1
        }

        # Form the issue API URL dynamically
        ISSUE_API_URL="https://api.github.com/repos/$repo/issues/$issue_num"

        # Fetch issue details with curl
        fetch_issue_status() {
          local url="$1"
          echo "url -> $url"
          if [[ "$repo" == "devtron-labs/devtron" || "$repo" == "devtron-labs/devtron-services" || "$repo" == "devtron-labs/dashboard" ]]; then
            status_code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
          else
            status_code=$(curl -s -o /dev/null -w "%{http_code}" --header "Authorization: Bearer ${{ secrets.GH_PR_VALIDATOR_TOKEN }}" "$url")
          fi
        }

        # Get the issue response code
        fetch_issue_status "$ISSUE_API_URL"

        echo "STATUS CODE: $status_code"
        # Handle response based on status code
        if [[ "$status_code" -eq 200 ]]; then
          echo "Issue #$issue_num exists in $repo."

          # Add labels based on forked status and issue validity
          if [[ "$FORKED" == true ]]; then
            gh pr edit "$PRNUM" --remove-label "PR:Issue-verification-failed" --add-label "PR:Ready-to-Review"
            exit 0
          fi
          gh pr edit "$PRNUM" --remove-label "PR:Issue-verification-failed" --add-label "PR:Ready-to-Review"
          exit 0
        else
          echo "Issue not found. Invalid URL or issue number."
          gh pr comment "$PRNUM" --body "PR is not linked to a valid issue. Please update the issue link."
          gh pr edit "$PRNUM" --add-label "PR:Issue-verification-failed" --remove-label "PR:Ready-to-Review"
          exit 1
        fi

    - name: Check SQL file format and duplicates (if enabled)
      if: inputs.validate_sql == true
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        # Get the target (base) and source (head) branches
        BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
        HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"

        # Fetch the latest changes from the base and target branches
        git fetch origin "$BASE_BRANCH"
        git fetch origin "$HEAD_BRANCH"

        # Get the list of changed files between the base and target branches
        git diff origin/"$BASE_BRANCH"...origin/"$HEAD_BRANCH" --name-only > diff

        # Specify the directory containing migration files
        MIGRATION_DIR="scripts/sql"

        # Print the current directory and the contents of the diff file
        echo "Current directory:"
        pwd
        echo "Files changed between $BASE_BRANCH and $HEAD_BRANCH:"
        cat diff

        # Initialize an empty variable to hold .up.sql files
        changed_files=""

        # Loop through the list of changed files and filter .up.sql files in the migration directory
        while IFS= read -r file; do
            if [[ $file == $MIGRATION_DIR/* && $file == *.up.sql ]]; then
                changed_files+="$file\n"
            fi
        done < diff

        # Print the filtered .up.sql files
        echo "Filtered .up.sql files:"
        echo -e "$changed_files"

        # If no .up.sql migration files are found, exit early
        if [[ -z "$changed_files" ]]; then
            echo "No .up.sql migration files found in the changes."
            exit 0
        fi

        # Extract unique migration numbers from the existing migration files in the directory
        existing_migrations=$(ls "$MIGRATION_DIR" | grep -E "\.up\.sql$" | grep -oE "[0-9]{6}[0-9]{2}" | sort -n | uniq)

        # Loop through each changed .up.sql file to validate
        is_valid=true
        processed_migrations=()
        while IFS= read -r file; do
            # Extract migration number from the file
            migration_number=$(basename "$file" | grep -oE "[0-9]{6}[0-9]{2}")
          
            # Validate the file name format (ensure it has the full XXXPPPNN format)
            if [[ ! $(basename "$file") =~ ^[0-9]{6}[0-9]{2}_ ]]; then
                echo "Error: Migration file $file does not have the complete XXXPPPNN format."
                is_valid=false
                continue
            fi

            # Check if we could extract a valid migration number
            if [[ -z "$migration_number" ]]; then
                echo "Warning: Could not extract migration number from $file."
                continue
            fi

            # Check if this migration number has already been processed
            if [[ " ${processed_migrations[@]} " =~ " $migration_number " ]]; then
                continue
            fi
            processed_migrations+=("$migration_number")

            # Check if the migration number already exists
            if echo "$existing_migrations" | grep -q "$migration_number"; then
                echo "Error: Migration number $migration_number already exists in the directory."
                is_valid=false
            fi

            # Check if the migration number is greater than previous ones (order check)
            last_migration=$(echo "$existing_migrations" | tail -n 1)
            if [[ "$migration_number" -le "$last_migration" ]]; then
                echo "Error: Migration number $migration_number is not greater than the latest ($last_migration)."
                is_valid=false
            fi

            # Check for sequential hotfix requirement (if NN > 01, check for NN-1)
            hotfix_number=$(echo "$migration_number" | grep -oE "[0-9]{2}$")
            if [[ "$hotfix_number" -gt "01" ]]; then
                previous_hotfix=$(printf "%02d" $((10#$hotfix_number - 1)))
                expected_previous_number="${migration_number:0:6}$previous_hotfix"
                if ! echo "$existing_migrations" | grep -q "$expected_previous_number"; then
                    echo "Error: Previous hotfix migration $expected_previous_number not found for $migration_number."
                    is_valid=false
                fi
            fi
          
        done <<< "$changed_files"

        # Final validation check
        if [ "$is_valid" = false ]; then
            echo "Validation failed. Please fix the errors before merging."
            gh pr comment "$pr_no" --body "The Migration files provided inside the PR do not pass the criteria!!"
            exit 1
        fi

        echo "All .up.sql migration file validations passed."
        gh pr comment "$pr_no" --body "The migration files have successfully passed the criteria!!"
        exit 0
