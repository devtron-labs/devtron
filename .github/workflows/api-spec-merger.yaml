name: API Specs Merger

on:
  push:
    paths:
      - 'specs/**'

permissions:
  contents: write

jobs:
  lint-bundle-host:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Redocly CLI
        run: npm install -g @redocly/cli

      - name: Run specs bundling script
        working-directory: ${{ github.workspace }}
        run: |
          chmod +x scripts/generate-api-docs.sh
          ./scripts/generate-api-docs.sh

      - name: Commit and push documentation
        env:
          GITHUB_TOKEN: ${{ secrets.GH_SYSTEMSDT_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Fetch the gh-pages branch
          git fetch origin gh-pages

          # Create a separate worktree for the branch
          git worktree add /tmp/gh-pages gh-pages

          # Copy generated docs into the worktree
          mkdir -p /tmp/gh-pages/docs/api-docs
          cp -r docs/api-docs/* /tmp/gh-pages/docs/api-docs/ || true

          cd /tmp/gh-pages

          git add .
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "ðŸ“„ Update API documentation"
            git push origin gh-pages
            echo "ðŸš€ Documentation pushed to gh-pages branch!"
          fi
      
